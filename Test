import React, { useMemo, useState } from "react";

/* ================= CONFIG ================= */
const YEAR = 2026;

const EVENT_COLORS = ["red", "purple", "blue", "green", "orange"];

/* PH + AU holidays with names */
const HOLIDAYS = {
  "2026-01-01": { name: "New Year’s Day", ph: true, au: true },
  "2026-01-26": { name: "Australia Day", ph: false, au: true },
  "2026-04-03": { name: "Good Friday", ph: false, au: true },
  "2026-04-09": { name: "Araw ng Kagitingan", ph: true, au: false },
  "2026-05-01": { name: "Labor Day", ph: true, au: false },
  "2026-06-12": { name: "Independence Day (PH)", ph: true, au: false },
  "2026-11-30": { name: "Bonifacio Day", ph: true, au: false },
  "2026-12-25": { name: "Christmas Day", ph: true, au: true }
};

const monthNames = [
  "January","February","March","April","May","June",
  "July","August","September","October","November","December"
];

const weekdays = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"];

/* ================= HELPERS ================= */
const daysInMonth = (y, m) => new Date(y, m + 1, 0).getDate();
const formatDate = (d) => d.toISOString().slice(0, 10);
const isWeekend = (d) => d.getDay() === 0 || d.getDay() === 6;

/* ================= APP ================= */
export default function Calendar365() {
  const [events, setEvents] = useState({}); // { date: [{ id, text, color }] }
  const [draft, setDraft] = useState({});   // temp input per cell

  const months = useMemo(() => {
    return monthNames.map((name, m) => {
      const days = Array.from({ length: daysInMonth(YEAR, m) }, (_, i) => {
        const date = new Date(YEAR, m, i + 1);
        const key = formatDate(date);
        const h = HOLIDAYS[key];
        return {
          key,
          day: i + 1,
          weekday: weekdays[(date.getDay() + 6) % 7],
          weekend: isWeekend(date),
          holiday: h
        };
      });
      return { name, days };
    });
  }, []);

  /* ============ EVENT ACTIONS ============ */
  const addEvent = (date) => {
    if (!draft[date]) return;
    setEvents({
      ...events,
      [date]: [...(events[date] || []), {
        id: crypto.randomUUID(),
        text: draft[date],
        color: EVENT_COLORS[0]
      }]
    });
    setDraft({ ...draft, [date]: "" });
  };

  const updateEvent = (date, id, updates) => {
    setEvents({
      ...events,
      [date]: events[date].map(e => e.id === id ? { ...e, ...updates } : e)
    });
  };

  const deleteEvent = (date, id) => {
    setEvents({
      ...events,
      [date]: events[date].filter(e => e.id !== id)
    });
  };

  const moveEvent = (from, to, event) => {
    deleteEvent(from, event.id);
    setEvents({
      ...events,
      [to]: [...(events[to] || []), event]
    });
  };

  /* ============ EXPORT ============ */
  const exportCSV = () => {
    let rows = [["Date", "Event", "Color"]];
    Object.entries(events).forEach(([d, evs]) =>
      evs.forEach(e => rows.push([d, e.text, e.color]))
    );
    const csv = rows.map(r => r.join(",")).join("\n");
    const blob = new Blob([csv], { type: "text/csv" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "calendar-events.csv";
    a.click();
  };

  const exportPDF = () => window.print();

  /* ================= UI ================= */
  return (
    <div className="p-6 space-y-4">
      <h1 className="text-2xl font-semibold">{YEAR} • 365-Day Calendar</h1>

      <div className="flex gap-2">
        <button onClick={exportCSV} className="px-3 py-1 border rounded">
          Export Excel
        </button>
        <button onClick={exportPDF} className="px-3 py-1 border rounded">
          Export PDF
        </button>
      </div>

      <div className="overflow-x-auto">
        <table className="border-collapse min-w-full">
          <thead>
            <tr>
              <th className="sticky left-0 bg-white">Month</th>
              {Array.from({ length: 31 }).map((_, i) => (
                <th key={i} className="text-xs">{i + 1}</th>
              ))}
            </tr>
          </thead>

          <tbody>
            {months.map((month, mi) => (
              <tr key={mi}>
                <td className="sticky left-0 bg-white font-medium p-2">
                  {month.name}
                </td>

                {Array.from({ length: 31 }).map((_, di) => {
                  const day = month.days[di];
                  if (!day) return <td key={di} className="border" />;

                  const h = day.holiday;
                  const bg =
                    h?.ph && h?.au ? "bg-green-100" :
                    h?.ph ? "bg-yellow-100" :
                    h?.au ? "bg-blue-100" :
                    day.weekend ? "bg-gray-200" :
                    "bg-white";

                  return (
                    <td
                      key={di}
                      className={`border align-top p-1 text-xs ${bg}`}
                      onDragOver={(e) => e.preventDefault()}
                      onDrop={(e) => {
                        const payload = JSON.parse(e.dataTransfer.getData("event"));
                        moveEvent(payload.from, day.key, payload.event);
                      }}
                    >
                      <div className="font-semibold">
                        {day.day} <span className="text-[10px]">{day.weekday}</span>
                      </div>

                      {h && (
                        <div className="text-[9px] italic">{h.name}</div>
                      )}

                      {(events[day.key] || []).map(ev => (
                        <div
                          key={ev.id}
                          draggable
                          onDragStart={(e) =>
                            e.dataTransfer.setData(
                              "event",
                              JSON.stringify({ event: ev, from: day.key })
                            )
                          }
                          onContextMenu={(e) => {
                            e.preventDefault();
                            const action = prompt("edit / delete / color");
                            if (action === "delete") deleteEvent(day.key, ev.id);
                            if (action === "edit") {
                              const t = prompt("Edit text", ev.text);
                              if (t) updateEvent(day.key, ev.id, { text: t });
                            }
                            if (action === "color") {
                              const c = prompt("Color:", EVENT_COLORS.join(", "));
                              if (EVENT_COLORS.includes(c))
                                updateEvent(day.key, ev.id, { color: c });
                            }
                          }}
                          className={`mt-1 p-1 rounded text-white text-[10px] bg-${ev.color}-500 cursor-move`}
                        >
                          {ev.text}
                        </div>
                      ))}

                      <input
                        className="w-full mt-1 text-[10px] border rounded px-1"
                        placeholder="Enter here"
                        value={draft[day.key] || ""}
                        onChange={(e) =>
                          setDraft({ ...draft, [day.key]: e.target.value })
                        }
                        onKeyDown={(e) =>
                          e.key === "Enter" && addEvent(day.key)
                        }
                      />
                    </td>
                  );
                })}
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  );
}
