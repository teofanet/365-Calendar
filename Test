import React, { useMemo, useState } from "react";
import * as XLSX from "xlsx";
import jsPDF from "jspdf";

const YEAR = 2026;

// --- Holiday maps with exact names ---
// Format: YYYY-MM-DD : "Holiday Name"
const PH_HOLIDAYS = {
  "2026-01-01": "New Year's Day",
  "2026-04-09": "Araw ng Kagitingan",
  "2026-05-01": "Labor Day",
  "2026-06-12": "Independence Day",
  "2026-08-31": "National Heroes Day",
  "2026-11-30": "Bonifacio Day",
  "2026-12-25": "Christmas Day"
};

const AU_HOLIDAYS = {
  "2026-01-01": "New Year's Day",
  "2026-01-26": "Australia Day",
  "2026-04-03": "Good Friday",
  "2026-04-06": "Easter Monday",
  "2026-12-25": "Christmas Day"
};

const monthNames = [
  "January","February","March","April","May","June",
  "July","August","September","October","November","December"
];

const EVENT_COLORS = [
  { name: "Red", class: "bg-red-400" },
  { name: "Purple", class: "bg-purple-400" },
  { name: "Blue", class: "bg-blue-400" },
  { name: "Green", class: "bg-green-400" },
  { name: "Orange", class: "bg-orange-400" }
];

function daysInMonth(year, month) {
  return new Date(year, month + 1, 0).getDate();
}

function isWeekend(date) {
  const d = date.getDay();
  return d === 0 || d === 6;
}

function formatDate(date) {
  return date.toISOString().slice(0, 10);
}

export default function Calendar365() {
  const [events, setEvents] = useState({});
  const [editingDate, setEditingDate] = useState(null);
  const [contextMenu, setContextMenu] = useState(null);

  const holidayInfo = useMemo(() => {
    const map = {};
    Object.keys(PH_HOLIDAYS).forEach(d => {
      map[d] = { name: PH_HOLIDAYS[d], type: "PH" };
    });
    Object.keys(AU_HOLIDAYS).forEach(d => {
      if (map[d]) {
        map[d] = { name: map[d].name, type: "BOTH" };
      } else {
        map[d] = { name: AU_HOLIDAYS[d], type: "AU" };
      }
    });
    return map;
  }, []);

  const months = useMemo(() => {
    return monthNames.map((name, m) => {
      const days = Array.from({ length: daysInMonth(YEAR, m) }, (_, i) => {
        const date = new Date(YEAR, m, i + 1);
        const key = formatDate(date);
        return {
          key,
          day: i + 1,
          weekend: isWeekend(date),
          holiday: holidayInfo[key]
        };
      });
      return { name, days };
    });
  }, [holidayInfo]);

  function addEvent(dateKey, title) {
    setEvents(prev => ({
      ...prev,
      [dateKey]: [
        ...(prev[dateKey] || []),
        { id: crypto.randomUUID(), title, color: EVENT_COLORS[0].class }
      ]
    }));
  }

  function updateEvent(dateKey, eventId, updates) {
    setEvents(prev => ({
      ...prev,
      [dateKey]: prev[dateKey].map(e =>
        e.id === eventId ? { ...e, ...updates } : e
      )
    }));
  }

  function deleteEvent(dateKey, eventId) {
    setEvents(prev => ({
      ...prev,
      [dateKey]: prev[dateKey].filter(e => e.id !== eventId)
    }));
  }

  function exportExcel() {
    const rows = [];
    Object.keys(events).forEach(date => {
      events[date].forEach(e => {
        rows.push({ Date: date, Event: e.title });
      });
    });
    const ws = XLSX.utils.json_to_sheet(rows);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Calendar");
    XLSX.writeFile(wb, `calendar-${YEAR}.xlsx`);
  }

  function exportPDF() {
    const doc = new jsPDF();
    let y = 10;
    doc.text(`Calendar ${YEAR}`, 10, y);
    y += 10;
    Object.keys(events).forEach(date => {
      events[date].forEach(e => {
        doc.text(`${date}: ${e.title}`, 10, y);
        y += 7;
        if (y > 280) {
          doc.addPage();
          y = 10;
        }
      });
    });
    doc.save(`calendar-${YEAR}.pdf`);
  }

  return (
    <div className="p-6 space-y-4" onClick={() => setContextMenu(null)}>
      <h1 className="text-2xl font-semibold">{YEAR} • 365-Day Calendar</h1>

      <div className="flex gap-3">
        <button onClick={exportExcel} className="px-3 py-1 border rounded">Export Excel</button>
        <button onClick={exportPDF} className="px-3 py-1 border rounded">Export PDF</button>
      </div>

      <div className="overflow-x-auto">
        <table className="border-collapse min-w-full">
          <thead>
            <tr>
              <th className="sticky left-0 bg-white z-10 p-2 text-left">Month</th>
              {Array.from({ length: 31 }).map((_, i) => (
                <th key={i} className="p-1 text-xs text-gray-500">{i + 1}</th>
              ))}
            </tr>
          </thead>
          <tbody>
            {months.map((month, mi) => (
              <tr key={mi}>
                <td className="sticky left-0 bg-white z-10 p-2 font-medium">{month.name}</td>
                {Array.from({ length: 31 }).map((_, di) => {
                  const day = month.days[di];
                  if (!day) return <td key={di} className="border" />;

                  const bg = day.holiday
                    ? day.holiday.type === "BOTH"
                      ? "bg-green-100"
                      : day.holiday.type === "PH"
                      ? "bg-yellow-100"
                      : "bg-blue-100"
                    : day.weekend
                    ? "bg-gray-200"
                    : "bg-white";

                  return (
                    <td
                      key={di}
                      className={`border p-1 align-top text-xs ${bg}`}
                      onDoubleClick={() => !day.holiday && setEditingDate(day.key)}
                    >
                      <div className="font-semibold">{day.day}</div>

                      {(events[day.key] || []).map(e => (
                        <div
                          key={e.id}
                          className={`mt-1 px-1 rounded text-white text-[10px] cursor-pointer ${e.color}`}
                          onContextMenu={(ev) => {
                            ev.preventDefault();
                            setContextMenu({ date: day.key, event: e, x: ev.clientX, y: ev.clientY });
                          }}
                        >
                          {e.title}
                        </div>
                      ))}

                      {day.holiday ? (
                        <div className="mt-1 text-[10px] font-semibold text-gray-700 select-none">
                          {day.holiday.name}
                        </div>
                      ) : editingDate === day.key ? (
                        <input
                          autoFocus
                          type="text"
                          className="w-full mt-1 text-[10px] border rounded px-1"
                          placeholder="Enter here"
                          onKeyDown={(e) => {
                            if (e.key === "Enter" && e.target.value) {
                              addEvent(day.key, e.target.value);
                              setEditingDate(null);
                            }
                          }}
                          onBlur={() => setEditingDate(null)}
                        />
                      ) : null}
                    </td>
                  );
                })}
              </tr>
            ))}
          </tbody>
        </table>
      </div>

      {contextMenu && (
        <div
          className="fixed bg-white border rounded shadow text-xs z-50"
          style={{ top: contextMenu.y, left: contextMenu.x }}
        >
          {EVENT_COLORS.map(c => (
            <div
              key={c.name}
              className="px-3 py-1 hover:bg-gray-100 cursor-pointer"
              onClick={() => {
                updateEvent(contextMenu.date, contextMenu.event.id, { color: c.class });
                setContextMenu(null);
              }}
            >
              Change color → {c.name}
            </div>
          ))}
          <div
            className="px-3 py-1 hover:bg-red-100 text-red-600 cursor-pointer"
            onClick={() => {
              deleteEvent(contextMenu.date, contextMenu.event.id);
              setContextMenu(null);
            }}
          >
            Delete
          </div>
        </div>
      )}
    </div>
  );
}
